<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç —Å –ü—É–¥–∂–æ–º –∏ –°–∏–¥–æ—Ä–æ–≤–∏—á–µ–º</title>
    <style>
        body { background: #121212; color: #fff; font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        #setup { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        input[type="text"] { width: 70%; padding: 10px; background: #222; border: 1px solid #555; color: #fff; }
        button { padding: 10px 20px; cursor: pointer; background: #4CAF50; color: white; border: none; font-weight: bold; }
        .chat-container { display: flex; flex-direction: column; gap: 10px; height: 400px; overflow-y: auto; border: 1px solid #333; padding: 10px; border-radius: 8px; }
        .message { padding: 10px; border-radius: 8px; max-width: 80%; }
        .user { align-self: flex-end; background: #007bff; }
        .pudge { align-self: flex-start; background: #8b0000; border-left: 4px solid red; }
        .sidor { align-self: flex-start; background: #556b2f; border-left: 4px solid lime; }
    </style>
</head>
<body>

    <!-- –í–ê–ñ–ù–û: –°—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Å—ã–ª–∫—É –∏–∑ Colab -->
    <div id="setup">
        <label>üîó –°—Å—ã–ª–∫–∞ Ngrok –∏–∑ Colab:</label>
        <div style="display:flex; gap:10px; margin-top:5px;">
            <input type="text" id="apiUrl" placeholder="https://....ngrok-free.app">
            <button onclick="saveUrl()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
        </div>
        <small style="color:#aaa;">–ö–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏–∑ –≤—ã–≤–æ–¥–∞ Colab –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ</small>
    </div>

    <div class="chat-container" id="chat">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è —Ç—É—Ç -->
    </div>

    <div style="margin-top: 15px; display:flex; gap:10px;">
        <input type="text" id="userMsg" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å...">
        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <script>
        let BACKEND_URL = localStorage.getItem("colab_url") || "";
        if(BACKEND_URL) document.getElementById("apiUrl").value = BACKEND_URL;

        function saveUrl() {
            let url = document.getElementById("apiUrl").value.trim();
            // –£–±–∏—Ä–∞–µ–º —Å–ª–µ—à –≤ –∫–æ–Ω—Ü–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if(url.endsWith("/")) url = url.slice(0, -1);
            localStorage.setItem("colab_url", url);
            BACKEND_URL = url;
            alert("–°—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –ú–æ–∂–Ω–æ —á–∞—Ç–∏—Ç—å—Å—è.");
        }

        async function sendMessage() {
            if (!BACKEND_URL) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–∑ Colab!");
            
            let text = document.getElementById("userMsg").value;
            if (!text) return;

            addMessage("–í—ã", text, "user");
            document.getElementById("userMsg").value = "";

            // 1. –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ü—É–¥–∂–∞
            await callCharacter("Pudge", text);
            
            // 2. –°–ø—Ä–∞—à–∏–≤–∞–µ–º –°–∏–¥–æ—Ä–æ–≤–∏—á–∞ (–ø—É—Å—Ç—å —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –æ—Ç–≤–µ—Ç –ü—É–¥–∂–∞, –Ω–æ —É–ø—Ä–æ—Å—Ç–∏–º –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ - –ø—É—Å—Ç—å —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –≤–∞—Å)
            // –í –∏–¥–µ–∞–ª–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é, –Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –ø—Ä–æ—Å—Ç–æ –µ—â–µ –∑–∞–ø—Ä–æ—Å
            await callCharacter("Sidor", "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª: " + text);
        }

        async function callCharacter(charName, prompt) {
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç..."
                let loadingId = addMessage(charName, "...", charName.toLowerCase());
                
                let response = await fetch(`${BACKEND_URL}/chat`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "ngrok-skip-browser-warning": "true" // <--- –í–û–¢ –≠–¢–û –ì–õ–ê–í–ù–û–ï
                    },
                    body: JSON.stringify({ text: prompt, character: charName })
                });

                if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                
                let data = await response.json();
                
                // –ó–∞–º–µ–Ω—è–µ–º "..." –Ω–∞ —Ç–µ–∫—Å—Ç
                document.getElementById(loadingId).innerHTML = `<strong>${charName}:</strong> ${data.text}`;
                
                // –ò–≥—Ä–∞–µ–º –∑–≤—É–∫
                let audio = new Audio(`${BACKEND_URL}${data.audio_url}`);
                audio.play();

            } catch (e) {
                alert("–û—à–∏–±–∫–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É Ngrok. " + e);
            }
        }

        function addMessage(name, text, cls) {
            let id = "msg-" + Math.random().toString(36).substr(2, 9);
            let div = document.createElement("div");
            div.id = id;
            div.className = `message ${cls}`;
            div.innerHTML = `<strong>${name}:</strong> ${text}`;
            let chat = document.getElementById("chat");
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            return id;
        }
    </script>
</body>
</html>

